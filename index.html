<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Gestionnaire de dettes personnel - Fonctionne 100% offline"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Mes Dettes" />
    <title>Gestionnaire de Dettes</title>
    <link rel="manifest" href="manifest.json" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üí∞</text></svg>"
    />
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-152x152.png" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
      <div class="install-banner-content">
        <h3>üì± Installer l'application</h3>
        <p>Installez l'app pour un acc√®s rapide et offline</p>
      </div>
      <button class="install-banner-btn" id="installBtn">Installer</button>
    </div>

    <!-- √âcran d'authentification -->
    <div class="auth-screen" id="authScreen">
      <div class="auth-box">
        <h2 class="auth-title" id="authTitle">Bienvenue</h2>
        <form id="authForm">
          <div class="form-group">
            <label class="form-label" for="passwordInput">Mot de passe</label>
            <input
              type="password"
              id="passwordInput"
              class="form-input"
              placeholder="Entrez votre mot de passe"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary btn-full-width">
            D√©verrouiller
          </button>
        </form>
        <p id="authMessage" class="auth-message"></p>
      </div>
    </div>

    <!-- Application principale -->
    <div class="header">
      <div class="header-content">
        <h1>üí∞ Mes Dettes</h1>
        <div class="header-actions">
          <div class="currency-selector">
            <button class="currency-btn active" data-currency="DH">DH</button>
            <button class="currency-btn" data-currency="$">$</button>
            <button class="currency-btn" data-currency="‚Ç¨">‚Ç¨</button>
          </div>
          <button class="menu-btn" id="menuBtn">‚ò∞</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="total-card">
        <h2>Total G√©n√©ral</h2>
        <div class="total-amount" id="totalAmount">0 DH</div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="addPersonBtn">
          ‚ûï Ajouter une personne
        </button>
        <button class="btn btn-secondary" id="addDebtBtn">
          üíµ Ajouter une dette
        </button>
      </div>

      <div class="person-list" id="personList">
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>Aucune dette enregistr√©e</p>
          <p class="empty-state-subtitle">Commencez par ajouter une personne</p>
        </div>
      </div>
    </div>

    <!-- Menu lat√©ral -->
    <div class="menu" id="menu">
      <div class="menu-content">
        <div class="menu-header">Menu</div>
        <div class="menu-item" id="exportBtn">üì§ Exporter les donn√©es</div>
        <div class="menu-item" id="importBtn">üì• Importer les donn√©es</div>
        <div class="menu-item" id="changePasswordBtn">
          üîê Changer le mot de passe
        </div>
        <div class="menu-item danger" id="clearDataBtn">
          üóëÔ∏è Effacer toutes les donn√©es
        </div>
      </div>
    </div>
    <input
      type="file"
      id="importFile"
      accept=".json"
      class="hidden-input"
      title="Importer un fichier JSON"
    />

    <!-- Modal Ajouter une personne -->
    <div class="modal" id="addPersonModal">
      <div class="modal-content">
        <div class="modal-header">Ajouter une personne</div>
        <form id="addPersonForm">
          <div class="form-group">
            <label class="form-label" for="personName"
              >Nom de la personne</label
            >
            <input
              type="text"
              id="personName"
              class="form-input"
              placeholder="Ex: Ahmed"
              required
            />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn" id="cancelPersonBtn">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary">Ajouter</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Ajouter une dette -->
    <div class="modal" id="addDebtModal">
      <div class="modal-content">
        <div class="modal-header">Ajouter une dette</div>
        <form id="addDebtForm">
          <div class="form-group">
            <label class="form-label" for="debtPerson">Personne</label>
            <select id="debtPerson" class="form-input" required>
              <option value="">S√©lectionnez une personne</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="debtAmount">Montant (DH)</label>
            <input
              type="number"
              id="debtAmount"
              class="form-input"
              placeholder="Ex: 500"
              step="0.01"
              required
            />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn" id="cancelDebtBtn">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary">Ajouter</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Changer mot de passe -->
    <div class="modal" id="changePasswordModal">
      <div class="modal-content">
        <div class="modal-header">Changer le mot de passe</div>
        <form id="changePasswordForm">
          <div class="form-group">
            <label class="form-label" for="currentPassword"
              >Mot de passe actuel</label
            >
            <input
              type="password"
              id="currentPassword"
              class="form-input"
              placeholder="Entrez votre mot de passe actuel"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label" for="newPassword"
              >Nouveau mot de passe</label
            >
            <input
              type="password"
              id="newPassword"
              class="form-input"
              placeholder="Entrez votre nouveau mot de passe"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label" for="confirmPassword"
              >Confirmer le mot de passe</label
            >
            <input
              type="password"
              id="confirmPassword"
              class="form-input"
              placeholder="Confirmez votre nouveau mot de passe"
              required
            />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn" id="cancelPasswordBtn">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary">Changer</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // ========== PWA INSTALLATION ==========

      let deferredPrompt;
      const installBanner = document.getElementById("installBanner");
      const installBtn = document.getElementById("installBtn");

      // Capturer l'√©v√©nement beforeinstallprompt
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBanner.classList.add("show");
      });

      // G√©rer le clic sur le bouton d'installation
      installBtn.addEventListener("click", async () => {
        if (!deferredPrompt) {
          return;
        }
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        deferredPrompt = null;
        installBanner.classList.remove("show");
      });

      // D√©tecter si l'app est d√©j√† install√©e
      window.addEventListener("appinstalled", () => {
        console.log("PWA install√©e avec succ√®s");
        installBanner.classList.remove("show");
        deferredPrompt = null;
      });

      // ========== GESTION DES DONN√âES ==========

      let data = {
        persons: [],
        currency: "DH",
      };

      const RATES = {
        DH: 1,
        $: 10,
        "‚Ç¨": 10,
      };

      function loadData() {
        const saved = localStorage.getItem("debtData");
        if (saved) {
          data = JSON.parse(saved);
        }
      }

      function saveData() {
        localStorage.setItem("debtData", JSON.stringify(data));
      }

      // ========== GESTION DE L'AUTHENTIFICATION ==========

      const authScreen = document.getElementById("authScreen");
      const authForm = document.getElementById("authForm");
      const passwordInput = document.getElementById("passwordInput");
      const authMessage = document.getElementById("authMessage");
      const authTitle = document.getElementById("authTitle");

      function hasPassword() {
        return localStorage.getItem("appPassword") !== null;
      }

      function initAuth() {
        if (!hasPassword()) {
          authTitle.textContent = "Cr√©er un mot de passe";
          authScreen.classList.add("active");
        } else {
          authTitle.textContent = "D√©verrouiller";
          authScreen.classList.add("active");
        }
      }

      authForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const password = passwordInput.value;

        if (!hasPassword()) {
          localStorage.setItem("appPassword", password);
          authScreen.classList.remove("active");
          loadData();
          render();
        } else {
          if (localStorage.getItem("appPassword") === password) {
            authScreen.classList.remove("active");
            loadData();
            render();
          } else {
            authMessage.textContent = "Mot de passe incorrect";
            authMessage.style.display = "block";
            passwordInput.value = "";
          }
        }
      });

      // ========== GESTION DE LA DEVISE ==========

      const currencyBtns = document.querySelectorAll(".currency-btn");

      currencyBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          currencyBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          data.currency = btn.dataset.currency;
          saveData();
          render();
        });
      });

      function convertAmount(amountDH) {
        return amountDH / RATES[data.currency];
      }

      function formatAmount(amountDH) {
        const converted = convertAmount(amountDH);
        return `${converted.toFixed(2)} ${data.currency}`;
      }

      // ========== GESTION DES PERSONNES ==========

      const addPersonBtn = document.getElementById("addPersonBtn");
      const addPersonModal = document.getElementById("addPersonModal");
      const addPersonForm = document.getElementById("addPersonForm");
      const cancelPersonBtn = document.getElementById("cancelPersonBtn");

      addPersonBtn.addEventListener("click", () => {
        addPersonModal.classList.add("active");
      });

      cancelPersonBtn.addEventListener("click", () => {
        addPersonModal.classList.remove("active");
        addPersonForm.reset();
      });

      addPersonForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("personName").value;

        const newPerson = {
          id: Date.now(),
          name: name,
          debts: [],
        };

        data.persons.push(newPerson);
        saveData();
        render();
        addPersonModal.classList.remove("active");
        addPersonForm.reset();
      });

      function deletePerson(personId) {
        if (
          confirm(
            "√ätes-vous s√ªr de vouloir supprimer cette personne et toutes ses dettes ?"
          )
        ) {
          data.persons = data.persons.filter((p) => p.id !== personId);
          saveData();
          render();
        }
      }

      // ========== GESTION DES DETTES ==========

      const addDebtBtn = document.getElementById("addDebtBtn");
      const addDebtModal = document.getElementById("addDebtModal");
      const addDebtForm = document.getElementById("addDebtForm");
      const cancelDebtBtn = document.getElementById("cancelDebtBtn");

      addDebtBtn.addEventListener("click", () => {
        if (data.persons.length === 0) {
          alert("Veuillez d'abord ajouter une personne");
          return;
        }
        updatePersonSelect();
        addDebtModal.classList.add("active");
      });

      cancelDebtBtn.addEventListener("click", () => {
        addDebtModal.classList.remove("active");
        addDebtForm.reset();
      });

      addDebtForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const personId = parseInt(document.getElementById("debtPerson").value);
        const amount = parseFloat(document.getElementById("debtAmount").value);

        const person = data.persons.find((p) => p.id === personId);
        if (person) {
          person.debts.push({
            id: Date.now(),
            amount: amount,
          });
          saveData();
          render();
          addDebtModal.classList.remove("active");
          addDebtForm.reset();
        }
      });

      function updatePersonSelect() {
        const select = document.getElementById("debtPerson");
        select.innerHTML =
          '<option value="">S√©lectionnez une personne</option>';
        data.persons.forEach((person) => {
          const option = document.createElement("option");
          option.value = person.id;
          option.textContent = person.name;
          select.appendChild(option);
        });
      }

      function deleteDebt(personId, debtId) {
        const person = data.persons.find((p) => p.id === personId);
        if (person) {
          person.debts = person.debts.filter((d) => d.id !== debtId);
          saveData();
          render();
        }
      }

      function addQuickDebt(personId) {
        const amount = prompt("Montant de la dette (DH):");
        if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
          const person = data.persons.find((p) => p.id === personId);
          if (person) {
            person.debts.push({
              id: Date.now(),
              amount: parseFloat(amount),
            });
            saveData();
            render();
          }
        }
      }

      // ========== MENU ==========

      const menuBtn = document.getElementById("menuBtn");
      const menu = document.getElementById("menu");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const importFile = document.getElementById("importFile");
      const changePasswordBtn = document.getElementById("changePasswordBtn");
      const clearDataBtn = document.getElementById("clearDataBtn");

      menuBtn.addEventListener("click", () => {
        menu.classList.add("active");
      });

      menu.addEventListener("click", (e) => {
        if (e.target === menu) {
          menu.classList.remove("active");
        }
      });

      exportBtn.addEventListener("click", () => {
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dettes_${new Date().toISOString().split("T")[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        menu.classList.remove("active");
      });

      importBtn.addEventListener("click", () => {
        importFile.click();
      });

      importFile.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              if (
                confirm(
                  "√ätes-vous s√ªr de vouloir importer ces donn√©es ? Les donn√©es actuelles seront remplac√©es."
                )
              ) {
                data = imported;
                saveData();
                render();
              }
            } catch (error) {
              alert("Erreur lors de l'import du fichier");
            }
          };
          reader.readAsText(file);
        }
        menu.classList.remove("active");
        importFile.value = "";
      });

      clearDataBtn.addEventListener("click", () => {
        if (
          confirm(
            "√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible."
          )
        ) {
          data = { persons: [], currency: "DH" };
          saveData();
          render();
          menu.classList.remove("active");
        }
      });

      const changePasswordModal = document.getElementById(
        "changePasswordModal"
      );
      const changePasswordForm = document.getElementById("changePasswordForm");
      const cancelPasswordBtn = document.getElementById("cancelPasswordBtn");

      changePasswordBtn.addEventListener("click", () => {
        menu.classList.remove("active");
        changePasswordModal.classList.add("active");
      });

      cancelPasswordBtn.addEventListener("click", () => {
        changePasswordModal.classList.remove("active");
        changePasswordForm.reset();
      });

      changePasswordForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const current = document.getElementById("currentPassword").value;
        const newPass = document.getElementById("newPassword").value;
        const confirm = document.getElementById("confirmPassword").value;

        if (localStorage.getItem("appPassword") !== current) {
          alert("Mot de passe actuel incorrect");
          return;
        }

        if (newPass !== confirm) {
          alert("Les mots de passe ne correspondent pas");
          return;
        }

        localStorage.setItem("appPassword", newPass);
        alert("Mot de passe chang√© avec succ√®s");
        changePasswordModal.classList.remove("active");
        changePasswordForm.reset();
      });

      // ========== RENDU DE L'INTERFACE ==========

      function render() {
        currencyBtns.forEach((btn) => {
          btn.classList.toggle(
            "active",
            btn.dataset.currency === data.currency
          );
        });

        let totalGeneral = 0;
        data.persons.forEach((person) => {
          person.debts.forEach((debt) => {
            totalGeneral += debt.amount;
          });
        });

        document.getElementById("totalAmount").textContent =
          formatAmount(totalGeneral);

        const personList = document.getElementById("personList");

        if (data.persons.length === 0) {
          personList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Aucune dette enregistr√©e</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Commencez par ajouter une personne</p>
                    </div>
                `;
        } else {
          personList.innerHTML = "";
          data.persons.forEach((person) => {
            const totalPerson = person.debts.reduce(
              (sum, debt) => sum + debt.amount,
              0
            );

            const card = document.createElement("div");
            card.className = "person-card";

            const debtsHTML = person.debts
              .map(
                (debt) => `
                        <div class="debt-item">
                            <span class="debt-amount">${formatAmount(
                              debt.amount
                            )}</span>
                            <div class="debt-actions">
                                <button class="icon-btn" onclick="deleteDebt(${
                                  person.id
                                }, ${debt.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `
              )
              .join("");

            const calculation =
              person.debts.length > 0
                ? `<p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">${person.debts
                    .map((d) => formatAmount(d.amount))
                    .join(" + ")} = ${formatAmount(totalPerson)}</p>`
                : "";

            card.innerHTML = `
                        <div class="person-header">
                            <span class="person-name">${person.name}</span>
                            <span class="person-total">${formatAmount(
                              totalPerson
                            )}</span>
                        </div>
                        ${calculation}
                        ${
                          person.debts.length > 0
                            ? `
                            <div class="debt-list">
                                ${debtsHTML}
                            </div>
                        `
                            : ""
                        }
                        <div class="person-actions">
                            <button class="small-btn" onclick="addQuickDebt(${
                              person.id
                            })">‚ûï Ajouter une dette</button>
                            <button class="small-btn danger" onclick="deletePerson(${
                              person.id
                            })">Supprimer</button>
                        </div>
                    `;

            personList.appendChild(card);
          });
        }
      }

      // ========== SERVICE WORKER POUR PWA ==========

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => console.log("‚úÖ Service Worker enregistr√©"))
            .catch((err) => console.log("‚ùå Erreur Service Worker:", err));
        });
      }

      // ========== INITIALISATION ==========

      initAuth();
    </script>
  </body>
</html>
